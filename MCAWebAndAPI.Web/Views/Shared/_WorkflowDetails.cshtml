@using MCAWebAndAPI.Model.ViewModel.Form.Common
@using MCAWebAndAPI.Model.ViewModel.Control

@model WorkflowRouterVM


<div class="col-sm-12">
    @(Html.Kendo().Grid<WorkflowItemVM>
        ()
        .Name("WorkflowDetails")
        .Editable(editable => editable.Mode(GridEditMode.InLine))
        .Columns(columns =>
        {
            columns.Bound(p => p.ID).Hidden();
            columns.Bound(p => p.Level).Width(150);
            columns.Bound(p => p.ApproverUnit).ClientTemplate("#=  ApproverUnit.Text #").Width(350)
            .EditorViewData(
            new
            {
                BindTo = WorkflowItemVM.GetUnitOptions()
            });
            columns.Bound(p => p.ApproverPosition).Width(300).ClientTemplate("#= ApproverPosition.Text #")
            .EditorViewData(
            new
            {
                DataTextField = "PositionName",
                DataValueField = "PositionName",
                ActionName = "GetApproverPositions",
                ControllerName = "Workflow",
                Filter = "filterApproverPosition",
                Cascade = "ApproverUnit"
            });
            columns.Bound(p => p.ApproverUserName).Width(400).ClientTemplate("#= ApproverUserName.Text #")
            .EditorViewData(
            new
            {
                DataTextField = "Name",
                DataValueField = "UserLogin",
                ActionName = "GetApproverNames",
                ControllerName = "Workflow",
                Filter = "filterApproverName",
                Cascade = "ApproverPosition"
            });
            columns.Command(p => p.Edit().Text("Edit").HtmlAttributes(new { @title = "Edit" })).Width(220);

        })
        .DataSource(
        dataSource =>
        dataSource.Ajax().Model(model =>
        {
            model.Id(p => p.ID);
            model.Field(p => p.ApproverUnit).DefaultValue(WorkflowItemVM.GetUnitDefaultValue());
            model.Field(m => m.ApproverPosition).DefaultValue(AjaxComboBoxVM.GetDefaultValue());
            model.Field(m => m.ApproverUserName).DefaultValue(AjaxComboBoxVM.GetDefaultValue());
            model.Field(p => p.Level).Editable(false);
        })
        .Read(read => read.Action("Grid_Read", "Workflow").Type(HttpVerbs.Post))
        .Update(update => update.Action("Grid_Update", "Workflow").Type(HttpVerbs.Post))
        )
    )

</div>

<script>

    function onChangeWorkflowDetails(e) {
        if (e.action == "itemchange") {
            if (e.field == "ApproverUnit") {
                var model = e.items[0];
                model.set("ApproverPosition", 0);
            }

            if (e.field == "ApproverPosition") {
                var model = e.items[0];
                model.set("ApproverUserName", 0);
            }
        }
    }

    function getCurrentEditedModel() {
        var grid = $("#WorkflowDetails").data("kendoGrid");
        var editRow = grid.tbody.find("tr:has(.k-edit-cell)");
        return grid.dataItem(editRow);
    }

    function filterApproverPosition(e) {
        return {
            approverUnit: $("#ApproverUnit").data("kendoDropDownList").value()
        };
    }

    function filterApproverName(e) {
        return {
            position: $("#ApproverPosition").data("kendoDropDownList").value()
        };
    }

</script>